"""
Telegram-–±–æ—Ç –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ —Å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è–º–∏ —Å–∞–π—Ç–∞.
–û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø—Ä–æ–≥—Ä–∞–º–º–µ –ê–ü–ì–†–ï–ô–î –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å —Å–∞–π—Ç–∞.
"""

import json
import os
from typing import Dict, Any
import requests

SITE_KNOWLEDGE = {
    "–æ –ø—Ä–æ–≥—Ä–∞–º–º–µ": """–ê–ü–ì–†–ï–ô–î ‚Äî —ç—Ç–æ 14-–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –∂–µ–Ω—â–∏–Ω.

–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø–æ–º–æ–≥–∞–µ—Ç, –µ—Å–ª–∏ —Ç—ã —Å—Ç–æ–ª–∫–Ω—É–ª–∞—Å—å —Å:
‚Ä¢ –≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–π –∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π —É—Å—Ç–∞–ª–æ—Å—Ç—å—é
‚Ä¢ –ê–ø–∞—Ç–∏–µ–π, —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ–º, "–Ω–∏—á–µ–≥–æ –Ω–µ —Ö–æ—á–µ—Ç—Å—è"
‚Ä¢ –ñ–∏–∑–Ω—å—é –≤ "–¥–Ω–µ —Å—É—Ä–∫–∞" ‚Äî –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –¥–Ω–∏
‚Ä¢ –ü–æ—Ç–µ—Ä–µ–π —Ä–∞–¥–æ—Å—Ç–∏ –∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è
‚Ä¢ –§–∏–∑–∏—á–µ—Å–∫–æ–π —Ç—è–∂–µ—Å—Ç—å—é –≤ —Ç–µ–ª–µ
‚Ä¢ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º –æ—â—É—â–µ–Ω–∏—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏
‚Ä¢ –ß—É–≤—Å—Ç–≤–æ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –Ω–µ—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏

–ó–∞ 14 –¥–Ω–µ–π —Ç—ã –∏–∑–º–µ–Ω–∏—à—å —Å–≤–æ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ! üíú""",

    "–ø–∞–∫–µ—Ç—ã": """–£ –ø—Ä–æ–≥—Ä–∞–º–º—ã 3 —Ñ–æ—Ä–º–∞—Ç–∞:

üéØ –°–û–õ–¨–ù–ê–Ø –≠–ö–°–ü–ï–î–ò–¶–ò–Ø ‚Äî 3000 ‚ÇΩ
‚Ä¢ 14 –¥–Ω–µ–π —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã
‚Ä¢ –ì–æ—Ç–æ–≤—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ –ø—Ä–∞–∫—Ç–∏–∫–∏
‚Ä¢ –ß–µ–∫-–ª–∏—Å—Ç—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
‚Ä¢ –¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞ 24/7

üë• –ì–†–£–ü–ü–û–í–û–ô –ü–û–õ–Å–¢ ‚Äî 10 000 ‚ÇΩ
‚Ä¢ –í—Å—ë –∏–∑ –°–û–õ–¨–ù–û–ô
‚Ä¢ –ó–∞–∫—Ä—ã—Ç—ã–π —á–∞—Ç –µ–¥–∏–Ω–æ–º—ã—à–ª–µ–Ω–Ω–∏—Ü
‚Ä¢ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ Zoom-–≤—Å—Ç—Ä–µ—á–∏
‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –æ—Ç –î–∞—Ä—å–∏

‚≠ê VIP-–ó–ê–ü–£–°–ö ‚Äî 30 000 ‚ÇΩ
‚Ä¢ –í—Å—ë –∏–∑ –ì–†–£–ü–ü–û–í–û–ô
‚Ä¢ 3 –ª–∏—á–Ω—ã–µ —Å–µ—Å—Å–∏–∏ —Å –î–∞—Ä—å–µ–π (90 –º–∏–Ω)
‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
‚Ä¢ –ü—Ä—è–º–∞—è —Å–≤—è–∑—å –≤ Telegram
‚Ä¢ –î–æ—Å—Ç—É–ø –∫ –∑–∞–∫—Ä—ã—Ç—ã–º –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–∞–º""",

    "—Ü–µ–Ω–∞": """–°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã:
‚Ä¢ –°–û–õ–¨–ù–ê–Ø –≠–ö–°–ü–ï–î–ò–¶–ò–Ø ‚Äî 3000 ‚ÇΩ
‚Ä¢ –ì–†–£–ü–ü–û–í–û–ô –ü–û–õ–Å–¢ ‚Äî 10 000 ‚ÇΩ
‚Ä¢ VIP-–ó–ê–ü–£–°–ö ‚Äî 30 000 ‚ÇΩ

–í—ã–±–µ—Ä–∏ —Ñ–æ—Ä–º–∞—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥—Ö–æ–¥–∏—Ç –∏–º–µ–Ω–Ω–æ —Ç–µ–±–µ! üíú""",

    "–∞–≤–∞—Ç–∞—Ä—ã": """–í –ø—Ä–æ–≥—Ä–∞–º–º–µ 5 –∞–≤–∞—Ç–∞—Ä–æ–≤ —É—á–∞—Å—Ç–Ω–∏—Ü:

1. –ó–ê–°–¢–†–Ø–í–®–ê–Ø ‚Äî —É—Å—Ç–∞–ª–∞ –æ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –¥–Ω–µ–π
2. –í–´–ì–û–†–ï–í–®–ê–Ø ‚Äî –Ω–µ—Ç —Å–∏–ª –Ω–∞ —Å–µ–±—è
3. –ò–©–£–©–ê–Ø –û–ü–û–†–£ ‚Äî –ø–æ—Ç–µ—Ä—è–ª–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
4. –ó–ê–ú–Å–†–ó–®–ê–Ø ‚Äî –∑–∞–±—ã–ª–∞ –ø—Ä–æ —Ä–∞–¥–æ—Å—Ç—å
5. –ü–û–¢–ï–†–Ø–í–®–ê–Ø –í–ö–£–° ‚Äî –∂–∏–∑–Ω—å —Å—Ç–∞–ª–∞ –ø—Ä–µ—Å–Ω–æ–π

–£–∑–Ω–∞–ª–∞ —Å–µ–±—è? –≠—Ç–æ —Ç–≤–æ–π –∑–Ω–∞–∫ –Ω–∞—á–∞—Ç—å! ‚ú®""",

    "–∫–æ–Ω—Ç–∞–∫—Ç—ã": """–°–≤—è–∂–∏—Å—å —Å–æ –º–Ω–æ–π –Ω–∞–ø—Ä—è–º—É—é:
üì± WhatsApp: +7 914 966 66 17
üí¨ Telegram: @dashapoddubnaya
üì∏ Instagram: @darya_tsybulskaya22

–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫, –î–∞–ª—å–Ω–∏–π –í–æ—Å—Ç–æ–∫ üåä""",

    "–∑–∞–ø–∏—Å—å": """–ß—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º—É, –Ω–∞–ø–∏—à–∏ –º–Ω–µ:
üì± WhatsApp: +7 914 966 66 17
üí¨ Telegram: @dashapoddubnaya

–ò–ª–∏ –≤—ã–±–µ—Ä–∏ —Ñ–æ—Ä–º–∞—Ç –Ω–∞ —Å–∞–π—Ç–µ –∏ –æ–ø–ª–∞—Ç–∏ –æ–Ω–ª–∞–π–Ω! üíú"""
}


def get_bot_response(user_message: str) -> str:
    """–ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π"""
    message_lower = user_message.lower()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
    if any(word in message_lower for word in ["–ø–∞–∫–µ—Ç", "—Ñ–æ—Ä–º–∞—Ç", "–≤–∞—Ä–∏–∞–Ω—Ç", "–∫–∞–∫–∏–µ", "–≤—ã–±—Ä–∞—Ç—å"]):
        return SITE_KNOWLEDGE["–ø–∞–∫–µ—Ç—ã"]
    
    if any(word in message_lower for word in ["—Ü–µ–Ω–∞", "—Å—Ç–æ–∏–º–æ—Å—Ç—å", "—Å–∫–æ–ª—å–∫–æ", "—Å—Ç–æ–∏—Ç", "—Ä—É–±–ª"]):
        return SITE_KNOWLEDGE["—Ü–µ–Ω–∞"]
    
    if any(word in message_lower for word in ["–∞–≤–∞—Ç–∞—Ä", "–∫—Ç–æ —è", "—Ç–∏–ø", "–∑–∞—Å—Ç—Ä—è–≤—à", "–≤—ã–≥–æ—Ä–µ–≤—à", "–∑–∞–º—ë—Ä–∑—à"]):
        return SITE_KNOWLEDGE["–∞–≤–∞—Ç–∞—Ä—ã"]
    
    if any(word in message_lower for word in ["–∫–æ–Ω—Ç–∞–∫—Ç", "—Å–≤—è–∑", "—Ç–µ–ª–µ—Ñ–æ–Ω", "whatsapp", "–∏–Ω—Å—Ç–∞–≥—Ä–∞–º"]):
        return SITE_KNOWLEDGE["–∫–æ–Ω—Ç–∞–∫—Ç—ã"]
    
    if any(word in message_lower for word in ["–∑–∞–ø–∏—Å–∞", "–ø—Ä–∏—Å–æ–µ–¥–∏–Ω", "–∫—É–ø–∏—Ç—å", "–æ–ø–ª–∞—Ç", "–∫–∞–∫ –Ω–∞—á–∞—Ç—å"]):
        return SITE_KNOWLEDGE["–∑–∞–ø–∏—Å—å"]
    
    if any(word in message_lower for word in ["–ø—Ä–æ–≥—Ä–∞–º", "–∞–ø–≥—Ä–µ–π–¥", "—á—Ç–æ —ç—Ç–æ", "–æ —á—ë–º", "–∑–∞—á–µ–º"]):
        return SITE_KNOWLEDGE["–æ –ø—Ä–æ–≥—Ä–∞–º–º–µ"]
    
    # –û—Ç–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    return """–ü—Ä–∏–≤–µ—Ç! üëã

–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ —É–∑–Ω–∞—Ç—å –æ –ø—Ä–æ–≥—Ä–∞–º–º–µ –ê–ü–ì–†–ï–ô–î.

–ù–∞–ø–∏—à–∏ —á—Ç–æ —Ç–µ–±—è –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç:
‚Ä¢ –û –ø—Ä–æ–≥—Ä–∞–º–º–µ
‚Ä¢ –§–æ—Ä–º–∞—Ç—ã –∏ —Ü–µ–Ω—ã
‚Ä¢ –ö–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è
‚Ä¢ –ö–æ–Ω—Ç–∞–∫—Ç—ã –î–∞—Ä—å–∏

–ò–ª–∏ —Å—Ä–∞–∑—É –ø–∏—à–∏ –î–∞—Ä—å–µ: @dashapoddubnaya üíú"""


def handler(event: Dict[str, Any], context) -> Dict[str, Any]:
    """Webhook –¥–ª—è Telegram –±–æ—Ç–∞"""
    method = event.get('httpMethod', 'POST')
    
    if method == 'OPTIONS':
        return {
            'statusCode': 200,
            'headers': {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type'
            },
            'body': '',
            'isBase64Encoded': False
        }
    
    if method != 'POST':
        return {
            'statusCode': 405,
            'headers': {'Content-Type': 'application/json'},
            'body': json.dumps({'error': 'Method not allowed'}),
            'isBase64Encoded': False
        }
    
    try:
        body = json.loads(event.get('body', '{}'))
        print(f"[DEBUG] Received update: {json.dumps(body)}")
        
        if 'message' not in body:
            print("[DEBUG] No message in update, skipping")
            return {
                'statusCode': 200,
                'headers': {'Content-Type': 'application/json'},
                'body': json.dumps({'ok': True}),
                'isBase64Encoded': False
            }
        
        message = body['message']
        chat_id = message['chat']['id']
        user_text = message.get('text', '')
        print(f"[DEBUG] User {chat_id} sent: {user_text}")
        
        if user_text.startswith('/start'):
            response_text = """–ü—Ä–∏–≤–µ—Ç! üëã 

–Ø –ø–æ–º–æ—â–Ω–∏–∫ –î–∞—Ä—å–∏ –¶—ã–±—É–ª—å—Å–∫–æ–π. –û—Ç–≤–µ—á—É –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø—Ä–æ–≥—Ä–∞–º–º–µ –ê–ü–ì–†–ï–ô–î ‚Äî 14-–¥–Ω–µ–≤–Ω–æ–π —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –∂–µ–Ω—â–∏–Ω.

–°–ø—Ä–∞—à–∏–≤–∞–π —á—Ç–æ —É–≥–æ–¥–Ω–æ:
‚Ä¢ –û –ø—Ä–æ–≥—Ä–∞–º–º–µ –∏ —Ñ–æ—Ä–º–∞—Ç–∞—Ö
‚Ä¢ –û —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–∞–∫–µ—Ç–æ–≤
‚Ä¢ –ö–∞–∫–æ–π –ø–∞–∫–µ—Ç –ø–æ–¥–æ–π–¥—ë—Ç —Ç–µ–±–µ
‚Ä¢ –ö–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è

–ò–ª–∏ —Å—Ä–∞–∑—É –ø–∏—à–∏ –î–∞—Ä—å–µ: @dashapoddubnaya üíú"""
        else:
            response_text = get_bot_response(user_text)
        
        bot_token = os.environ.get('TELEGRAM_BOT_TOKEN')
        if not bot_token:
            print("[ERROR] Bot token not found in environment")
            return {
                'statusCode': 500,
                'headers': {'Content-Type': 'application/json'},
                'body': json.dumps({'error': 'Bot token not configured'}),
                'isBase64Encoded': False
            }
        
        print(f"[DEBUG] Sending response to {chat_id}: {response_text[:100]}...")
        send_response = requests.post(
            f'https://api.telegram.org/bot{bot_token}/sendMessage',
            json={
                'chat_id': chat_id,
                'text': response_text
            },
            timeout=10
        )
        print(f"[DEBUG] Telegram API response: {send_response.status_code} - {send_response.text}")
        
        return {
            'statusCode': 200,
            'headers': {'Content-Type': 'application/json'},
            'body': json.dumps({'ok': True}),
            'isBase64Encoded': False
        }
        
    except Exception as e:
        print(f"[ERROR] Handler exception: {str(e)}")
        import traceback
        print(f"[ERROR] Traceback: {traceback.format_exc()}")
        return {
            'statusCode': 500,
            'headers': {'Content-Type': 'application/json'},
            'body': json.dumps({'error': str(e)}),
            'isBase64Encoded': False
        }
